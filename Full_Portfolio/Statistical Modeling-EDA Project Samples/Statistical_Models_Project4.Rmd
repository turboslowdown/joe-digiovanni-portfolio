---
title: "Mortgage Analysis"
output:
  pdf_document: default
  html_document: default
---

```{r setup}
setwd("/Users/josephndigiovanni/Downloads")
require(dplyr)
```

```{r load_data}
#pull orig dataset
orig <- read.csv('sample_orig_2007.txt', sep='|', header=FALSE)
head(orig)

#rename columns based on the user guide
colnames(orig) <- c(
  "credit_score", "first_payment_date", "first_time_homebuyer_flag",
  "maturity_date", "msa_or_metropolitan_division", "mortgage_insurance_percentage",
  "number_of_units", "occupancy_status", "original_combined_loan_to_value",
  "original_debt_to_income_ratio", "original_upb", "original_loan_to_value",
  "original_interest_rate", "channel", "prepayment_penalty_mortgage_flag",
  "amortization_type", "property_state", "property_type", "postal_code",
  "loan_id", "loan_purpose", "original_loan_term", "number_of_borrowers",
  "seller_name", "servicer_name", "super_conforming_flag",
  "pre_relief_refinance_loan_sequence_number", "program_indicator",
  "relief_refinance_indicator", "property_valuation_method",
  "interest_only_indicator", "mi_cancellation_indicator"
)
```

```{r process_svcg}
#pull svcg dataset
svcg <- read.csv('sample_svcg_2007.txt', sep='|', header=FALSE)

#select specified columns
svcg <- svcg[, c(1, 4, 5, 7, 22)]

#rename columns based on user guide
colnames(svcg) <- c("loan_id", "status", "age", "settlement_date", "loss")

#count rows and examine structure
nrow(svcg)
str(svcg)

#counting unique loan ids
length(unique(svcg$loan_id))

#only examine loans in first 36 months
svcg <- svcg %>%
  filter(age <= 36)

length(unique(svcg$loan_id))
```

```{r create_flags}
#define status values for default
status_values <- c("3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", 
                  "14", "15", "16", "17", "RA", "18", "19", "20", "21", "22", 
                  "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", 
                  "33", "34", "35", "36", "42", "43", "37", "38","39","41",
                  "40","44","45","46","47","48","49","50","51")

#create default and defect flags
svcg <- svcg %>%
  mutate(
    default_flag = case_when(
      status %in% status_values | loss < 0 ~ 1,
      is.na(loss) ~ 0,
      TRUE ~ 0
    ),
    defect_flag = case_when(
      !is.na(settlement_date) ~ 1,
      TRUE ~ 0
    )
  )

loss_na <- svcg %>%
  filter(is.na(loss))
View(loss_na)
```

```{r unique_loans}
#count unique defaulted and defected loans
unique_defaulted_loans <- svcg %>%
  filter(default_flag == 1) %>%
  summarise(unique_loan_count = length(unique(loan_id)))

unique_defected_loans <- svcg %>%
  filter(defect_flag == 1) %>%
  summarise(unique_loan_count = length(unique(loan_id)))

svcg_unique_loans <- svcg %>%
  group_by(loan_id) %>%
  mutate(
    default_flag = ifelse(any(default_flag == 1), 1, default_flag),
    defect_flag = ifelse(any(defect_flag == 1), 1, defect_flag)
  ) %>%
  ungroup()

svcg_unique_loans_distinct <- svcg_unique_loans %>%
  distinct(loan_id, .keep_all = TRUE)
```

```{r merge_data}
#merge datasets
loans <- merge(orig, svcg_unique_loans_distinct[, c("loan_id", "default_flag", "defect_flag")], 
              by = "loan_id")

#clean outliers
loans <- loans %>%
  filter(credit_score <= 850 & credit_score >= 300) %>%
  filter(original_combined_loan_to_value < 999) %>%
  filter(original_debt_to_income_ratio < 999)

#examine summaries
summary(loans$credit_score)
summary(loans$original_combined_loan_to_value)
summary(loans$original_debt_to_income_ratio)
summary(loans$original_upb)
summary(loans$original_interest_rate)
```

```{r logit_model}
#fit logistic regression
logit <- glm(default_flag ~ credit_score + original_combined_loan_to_value +
               original_debt_to_income_ratio + original_upb + original_interest_rate,
             family = binomial(link = 'logit'), data = loans)

summary(logit)

#plot fitted values
fitted_values <- fitted(logit)
plot(fitted_values, main = "Fitted Values of GLM", 
     xlab = "Index", ylab = "Fitted Values", pch = 19, col = "blue")
plot(loans$default_flag, fitted_values, main = "Actual vs Fitted", 
     xlab = "Actual Values", ylab = "Fitted Values")
abline(0, 1, col = "red", lty = 2)

#examine coefficients
exp(logit$coefficients)
exp(logit$coefficients) - 1
```

```{r model_assessment}
#assess model fit
null_dev <- 31028
resid_dev <- 26419
diff_dev <- null_dev - resid_dev
1 - pchisq(diff_dev, 5)

#fit probit model for comparison
probit <- glm(default_flag ~ credit_score + original_combined_loan_to_value +
                original_debt_to_income_ratio + original_upb + original_interest_rate,
              family = binomial(link = 'probit'), data = loans)

#confusion matrices and AIC
confusion <- function(glm) table(list(Actual = glm$y, Preds = (glm$fitted.values > 0.50)))
confusion(logit)
confusion(probit)
AIC(logit)
AIC(probit)
```

```{r loss_analysis}
#calculate losses
losses <- loans %>%
  filter(defect_flag == 1) 

fitted_probabilities <- predict(logit, newdata = losses, type = "response")

losses <- losses %>%
  mutate(
    fitted_prob_default = fitted_probabilities,
    expected_loss = original_upb * 0.25 * fitted_probabilities,
    observed_loss = if_else(defect_flag == 1 & default_flag == 1, 
                           original_upb * 0.25, 0)
  )

#scale losses
total_expected_loss <- sum(losses$expected_loss)
total_observed_loss <- sum(losses$observed_loss)
scaled_expected_loss <- total_expected_loss * 20
scaled_observed_loss <- total_observed_loss * 20

cat("Total Expected Loss (scaled for 1M loans):", scaled_expected_loss, "\n")
cat("Total Observed Loss (scaled for 1M loans):", scaled_observed_loss, "\n")
```

```{r refined_model}
#fit refined model
refined_logit <- glm(
  default_flag ~ credit_score + original_combined_loan_to_value +
    original_upb + original_interest_rate + loan_purpose + occupancy_status +
    credit_score:original_combined_loan_to_value,
  family = binomial(link = "logit"),
  data = loans
)

summary(refined_logit)

#calculate metrics
predicted_probs <- predict(refined_logit, type = "response")
optimal_threshold <- 0.05
predicted_classes <- ifelse(predicted_probs > optimal_threshold, 1, 0)

accuracy <- (43853 + 129)/(43853 + 4596 + 155 + 129)
precision <- 129/(129 + 155)
recall <- 129/(129 + 4596)
recall_0 <- 43853/(43853 + 155)
balanced_accuracy <- (recall + recall_0)/2

cat("Refined AIC:", AIC(refined_logit), "\n")
cat("Accuracy:", accuracy, "\n")
cat("Precision:", precision, "\n")
cat("Recall:", recall, "\n")
cat("Balanced Accuracy:", balanced_accuracy, "\n")

#calculate profit
loan_balances <- loans$original_upb
profit_per_loan <- ifelse(
  predicted_classes == 1,
  -0.25 * loan_balances,
  0.01 * loan_balances
)

total_profit <- sum(profit_per_loan)
cat("Total Profit:", total_profit, "\n")
```